module.exports=[77841,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(49281),e=a.i(55565),f=a.i(63825),g=a.i(83772),h=a.i(27387),i=a.i(46764),j=a.i(27730),k=a.i(76130),l=a.i(64831),m=a.i(71306),n=a.i(68186),o=a.i(72348),p=a.i(24569),q=a.i(77156),r=a.i(15618),s=a.i(87532),t=a.i(81560),u=a.i(8193),v=a.i(72838),w=a.i(42351);let x=["FACULTY_ADMIN","SUPER_ADMIN"],y=[{value:"OPEN_REGISTRATION",label:"เปิดรับสมัคร"},{value:"IN_PROGRESS",label:"กำลังดำเนินการ"},{value:"CLOSED",label:"ปิดกิจกรรม"},{value:"CANCELLED",label:"ยกเลิกกิจกรรม"}],z=[{value:"BOTH",label:"ทั่วไป (รูปภาพหรือ PDF)"},{value:"PHOTO",label:"รูปภาพเท่านั้น"},{value:"PDF",label:"PDF เท่านั้น"}],A=a=>{let b=new Map;return a.forEach(a=>{a?.id&&b.set(a.id,a)}),Array.from(b.values())},B=a=>a?Array.isArray(a)?a.filter(Boolean):[a]:[],C=a=>{if(!a)return;let b=new Date(a);if(Number.isNaN(b.getTime()))return;let c=60*b.getTimezoneOffset()*1e3;return new Date(b.getTime()-c).toISOString().slice(0,16)},D=a=>{if(!a)return null;let b=new Date(a);return Number.isNaN(b.getTime())?null:b.toISOString()},E=a=>Array.isArray(a.departments)&&a.departments.length>0?a.departments:a.department?.id?[a.department]:[],F=a=>Array.isArray(a.majorJoins)?a.majorJoins:[];function G(){let[a]=f.Form.useForm(),G=f.Form.useWatch("departmentIds",a),[H,I]=(0,c.useState)(null),[J,K]=(0,c.useState)(!1),[L,M]=(0,c.useState)(!1),[N,O]=(0,c.useState)([]),[P,Q]=(0,c.useState)([]),[R,S]=(0,c.useState)([]),[T,U]=(0,c.useState)([]),[V,W]=(0,c.useState)(""),[X,Y]=(0,c.useState)(null),[Z,$]=(0,c.useState)(null),[_,aa]=(0,c.useState)(!1),[ab,ac]=(0,c.useState)(!1),[ad,ae]=(0,c.useState)(null),[af,ag]=(0,c.useState)(null),ah=x.includes(H?.role),ai=!ah&&H?.departmentId||null,aj=async(b,c=!0)=>{let d=A(B(b).map(a=>({id:a}))).map(a=>a.id);if(0===d.length){S([]),c||a.setFieldValue("majorIds",[]);return}try{let b=(await Promise.all(d.map(async a=>{try{return await (0,v.getMajorsByDepartment)(a)}catch(a){return[]}}))).flat(),e=A(b).sort((a,b)=>String(a.code||"").localeCompare(String(b.code||""),"th"));if(S(e),c){let b=B(a.getFieldValue("majorIds")),c=new Set(e.map(a=>a.id));a.setFieldValue("majorIds",b.filter(a=>c.has(a)))}}catch(a){S([])}},ak=async()=>{K(!0);try{let a,b=(a=localStorage.getItem("user"))?JSON.parse(a):null;I(b);let c=x.includes(b?.role),[d,e,f]=await Promise.all([(0,u.getAllActivities)(),(0,w.getAllTypeActivities)(),c?(0,v.getAllDepartments)():Promise.resolve([])]);if(O(Array.isArray(d)?d:[]),U(Array.isArray(e)?e:[]),c)Q(Array.isArray(f)?f:[]);else if(b?.department?.id)Q([b.department]);else{let a=A((Array.isArray(d)?d:[]).flatMap(a=>E(a)).filter(a=>a?.id));Q(a)}}catch(b){let a=b?.response?.data?.message||"ไม่สามารถโหลดข้อมูลกิจกรรมได้";o.message.error(a)}finally{K(!1)}};(0,c.useEffect)(()=>{ak()},[]),(0,c.useEffect)(()=>{_&&aj(B(G),!0)},[G,_]);let al=(0,c.useMemo)(()=>{let a=V.trim().toLowerCase();return N.filter(b=>{if(ai&&!new Set(E(b).map(a=>a.id)).has(ai))return!1;if(a){let c=E(b).map(a=>String(a?.name||"")).join(" ").toLowerCase();if(!(String(b.name||b.title||"").toLowerCase().includes(a)||c.includes(a)))return!1}return(!X||!!new Set(E(b).map(a=>a.id)).has(X))&&(!Z||(b.typeActivity?.id||b.typeActivityId)===Z)})},[N,V,X,Z,ai]),am=(0,c.useMemo)(()=>({totalActivities:al.length,totalHours:al.reduce((a,b)=>a+Number(b.hour||b.hours||0),0)}),[al]),an=async()=>{ae(null),a.resetFields();let b=ai?[ai]:[];a.setFieldsValue({title:"",note:"",location:"",activityTypeId:void 0,requiredEvidenceType:"BOTH",hours:1,capacity:1,startAt:void 0,endAt:void 0,applyOpenAt:void 0,applyCloseAt:void 0,status:"OPEN_REGISTRATION",departmentIds:b,majorIds:[]}),await aj(b,!1),aa(!0)},ao=async b=>{ae(b);let c=B(b.departmentIds),d=c.length>0?c:E(b).map(a=>a.id),e=B(b.majorIds).length>0?B(b.majorIds):F(b).map(a=>a.majorId),f=ai?[ai]:d;a.setFieldsValue({title:b.title||b.name||"",note:b.note||b.description||"",location:b.location||b.address||"",activityTypeId:b.typeActivity?.id||b.typeActivityId,requiredEvidenceType:b.requiredEvidenceType||"BOTH",hours:b.hours||b.hour||1,capacity:b.capacity||b.maxPeopleCount||1,startAt:C(b.startAt||b.startDate),endAt:C(b.endAt||b.endDate),applyOpenAt:C(b.applyOpenAt||b.applyOpen),applyCloseAt:C(b.applyCloseAt||b.applyClose||b.date),status:b.status||"OPEN_REGISTRATION",departmentIds:f,majorIds:e}),await aj(f,!1),aa(!0)},ap=async a=>{try{await (0,u.deleteActivity)(a.id),o.message.success(`ลบกิจกรรม "${a.name||a.title}" สำเร็จ`),await ak()}catch(b){let a=b?.response?.data?.message||"ไม่สามารถลบกิจกรรมได้";o.message.error(a)}},aq=async b=>{M(!0);try{let c,d,e,f=(c=A(B(b.departmentIds).map(a=>({id:a}))).map(a=>a.id),d=ai&&!ah?[ai]:c,e=A(B(b.majorIds).map(a=>({id:a}))).map(a=>a.id),{title:b.title,note:b.note||"",location:b.location,activityTypeId:b.activityTypeId,requiredEvidenceType:b.requiredEvidenceType||"BOTH",hours:Number(b.hours||1),capacity:Number(b.capacity||1),startAt:D(b.startAt),endAt:D(b.endAt),applyOpenAt:D(b.applyOpenAt||b.startAt),applyCloseAt:D(b.applyCloseAt||b.startAt),status:b.status||"OPEN_REGISTRATION",departmentIds:d,majorIds:e});ad?(await (0,u.updateActivity)(ad.id,f),o.message.success("แก้ไขกิจกรรมสำเร็จ")):(await (0,u.createActivity)(f),o.message.success("เพิ่มกิจกรรมสำเร็จ")),aa(!1),ae(null),a.resetFields(),await ak()}catch(b){let a=b?.response?.data?.message||(ad?"ไม่สามารถแก้ไขกิจกรรมได้":"ไม่สามารถเพิ่มกิจกรรมได้");o.message.error(a)}finally{M(!1)}},ar=(0,c.useMemo)(()=>P.length>0?P:A(N.flatMap(a=>E(a))),[P,N]),as=[{title:"ลำดับ",width:80,align:"center",render:(a,b,c)=>c+1},{title:"กิจกรรม",dataIndex:"name",render:(a,b)=>b.name||b.title||"-"},{title:"ภาควิชา",width:260,render:(a,c)=>{let d=E(c);return(0,b.jsx)("div",{className:"flex flex-wrap gap-1",children:d.length>0?d.map(a=>(0,b.jsx)(n.Tag,{color:"blue",children:a.name},a.id)):(0,b.jsx)("span",{className:"text-gray-400",children:"-"})})}},{title:"สาขาวิชา",width:280,render:(a,c)=>{let d=F(c);return 0===d.length?(0,b.jsx)("span",{className:"text-gray-500",children:"ทุกสาขาในภาคที่เลือก"}):(0,b.jsx)("div",{className:"flex flex-wrap gap-1",children:d.map(a=>(0,b.jsxs)(n.Tag,{color:"#0A894C",children:[a.major?.code?`${a.major.code} - `:"",a.major?.name||a.majorId]},a.majorId))})}},{title:"ประเภทกิจกรรม",width:180,render:(a,c)=>(0,b.jsx)(n.Tag,{color:"green",children:c.typeActivity?.name||"ยังไม่กำหนดประเภท"})},{title:"นักศึกษา",width:130,align:"center",render:(a,c)=>{let d=Number(c.peopleCount||0),e=Number(c.maxPeopleCount||c.maxStudents||0);return(0,b.jsxs)("span",{className:"font-medium",style:{color:"#0A894C"},children:[d,"/",e]})}},{title:"จัดการ",width:160,align:"center",render:(a,c)=>(0,b.jsxs)(k.Space,{children:[(0,b.jsx)(d.Button,{type:"text",icon:(0,b.jsx)(q.Eye,{size:18}),onClick:()=>{ag(c),ac(!0)},title:"ดูข้อมูล"}),(0,b.jsx)(d.Button,{type:"text",icon:(0,b.jsx)(p.Edit,{size:18}),onClick:()=>ao(c),title:"แก้ไข"}),(0,b.jsx)(i.Popconfirm,{title:"ยืนยันการลบ",description:"ต้องการลบกิจกรรมนี้หรือไม่",onConfirm:()=>ap(c),okText:"ลบ",cancelText:"ยกเลิก",children:(0,b.jsx)(d.Button,{danger:!0,type:"text",icon:(0,b.jsx)(t.Trash2,{size:18}),title:"ลบ"})})]})}];return(0,b.jsx)(l.Spin,{spinning:J,children:(0,b.jsxs)("div",{children:[(0,b.jsx)(e.Card,{className:"mb-4",children:(0,b.jsxs)("div",{className:"grid grid-cols-12 gap-3",children:[(0,b.jsx)("div",{className:"col-span-12 lg:col-span-4",children:(0,b.jsx)(g.Input,{placeholder:"ค้นหาชื่อกิจกรรมหรือภาควิชา",value:V,onChange:a=>W(a.target.value),prefix:(0,b.jsx)(s.Search,{size:16})})}),(0,b.jsx)("div",{className:"col-span-12 lg:col-span-3",children:(0,b.jsx)(j.Select,{allowClear:!0,placeholder:"กรองตามภาควิชา",value:X,onChange:Y,style:{width:"100%"},options:ar.map(a=>({value:a.id,label:a.name}))})}),(0,b.jsx)("div",{className:"col-span-12 lg:col-span-3",children:(0,b.jsx)(j.Select,{allowClear:!0,placeholder:"กรองตามประเภทกิจกรรม",value:Z,onChange:$,style:{width:"100%"},options:T.map(a=>({value:a.id,label:`${a.code} - ${a.name}`}))})}),(0,b.jsx)("div",{className:"col-span-12 lg:col-span-2 flex justify-end",children:(0,b.jsx)(d.Button,{type:"primary",icon:(0,b.jsx)(r.Plus,{size:16}),onClick:an,style:{backgroundColor:"#0A894C",borderColor:"#0A894C"},children:"เพิ่มกิจกรรม"})})]})}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[(0,b.jsxs)(e.Card,{children:[(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"จำนวนกิจกรรม"}),(0,b.jsx)("div",{className:"text-3xl font-bold text-[#0A894C]",children:am.totalActivities})]}),(0,b.jsxs)(e.Card,{children:[(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"จำนวนชั่วโมงรวม"}),(0,b.jsx)("div",{className:"text-3xl font-bold text-[#0A894C]",children:am.totalHours})]})]}),(0,b.jsx)(e.Card,{children:(0,b.jsx)(m.Table,{rowKey:"id",columns:as,dataSource:al,pagination:{pageSize:10,showSizeChanger:!0},scroll:{x:1200}})}),(0,b.jsx)(h.Modal,{title:ad?"แก้ไขกิจกรรม":"เพิ่มกิจกรรม",open:_,onCancel:()=>{aa(!1),ae(null),a.resetFields()},onOk:()=>a.submit(),confirmLoading:L,okText:ad?"บันทึก":"สร้าง",cancelText:"ยกเลิก",width:920,children:(0,b.jsxs)(f.Form,{form:a,layout:"vertical",onFinish:aq,children:[(0,b.jsx)(f.Form.Item,{label:"ชื่อกิจกรรม",name:"title",rules:[{required:!0,message:"กรุณากรอกชื่อกิจกรรม"}],children:(0,b.jsx)(g.Input,{})}),(0,b.jsx)(f.Form.Item,{label:"ประเภทกิจกรรม",name:"activityTypeId",rules:[{required:!0,message:"กรุณาเลือกประเภทกิจกรรม"}],children:(0,b.jsx)(j.Select,{placeholder:"เลือกประเภทกิจกรรม",options:T.map(a=>({value:a.id,label:`${a.code} - ${a.name}`}))})}),(0,b.jsx)(f.Form.Item,{label:"ภาควิชา (เลือกได้หลายภาควิชา)",name:"departmentIds",rules:[{required:!0,message:"กรุณาเลือกภาควิชาอย่างน้อย 1 ภาควิชา"}],children:(0,b.jsx)(j.Select,{mode:"multiple",disabled:!ah,placeholder:ah?"เลือกภาควิชา":"ระบบกำหนดภาควิชาตามสิทธิ์",options:P.map(a=>({value:a.id,label:`${a.code?`${a.code} - `:""}${a.name}`}))})}),(0,b.jsx)(f.Form.Item,{label:"สาขาวิชา (ไม่เลือก = ทุกสาขาในภาคที่เลือก)",name:"majorIds",children:(0,b.jsx)(j.Select,{mode:"multiple",placeholder:"เลือกสาขาวิชา",options:R.map(a=>({value:a.id,label:`${a.code} - ${a.name}`}))})}),(0,b.jsx)(f.Form.Item,{label:"สถานที่",name:"location",rules:[{required:!0,message:"กรุณากรอกสถานที่"}],children:(0,b.jsx)(g.Input,{})}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,b.jsx)(f.Form.Item,{label:"วันเวลาเริ่มกิจกรรม",name:"startAt",rules:[{required:!0,message:"กรุณาเลือกวันเวลาเริ่ม"}],children:(0,b.jsx)(g.Input,{type:"datetime-local"})}),(0,b.jsx)(f.Form.Item,{label:"วันเวลาสิ้นสุดกิจกรรม",name:"endAt",rules:[{required:!0,message:"กรุณาเลือกวันเวลาสิ้นสุด"}],children:(0,b.jsx)(g.Input,{type:"datetime-local"})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,b.jsx)(f.Form.Item,{label:"วันเวลาเปิดรับสมัคร",name:"applyOpenAt",rules:[{required:!0,message:"กรุณาเลือกวันเวลาเปิดรับสมัคร"}],children:(0,b.jsx)(g.Input,{type:"datetime-local"})}),(0,b.jsx)(f.Form.Item,{label:"วันเวลาปิดรับสมัคร",name:"applyCloseAt",rules:[{required:!0,message:"กรุณาเลือกวันเวลาปิดรับสมัคร"}],children:(0,b.jsx)(g.Input,{type:"datetime-local"})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,b.jsx)(f.Form.Item,{label:"จำนวนชั่วโมงกิจกรรม",name:"hours",rules:[{required:!0,message:"กรุณากรอกจำนวนชั่วโมง"}],children:(0,b.jsx)(g.Input,{type:"number",min:1})}),(0,b.jsx)(f.Form.Item,{label:"จำนวนนักศึกษาสูงสุด",name:"capacity",rules:[{required:!0,message:"กรุณากรอกจำนวนรับสูงสุด"}],children:(0,b.jsx)(g.Input,{type:"number",min:1})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,b.jsx)(f.Form.Item,{label:"หลักฐานที่ต้องใช้",name:"requiredEvidenceType",rules:[{required:!0,message:"กรุณาเลือกประเภทหลักฐาน"}],children:(0,b.jsx)(j.Select,{options:z})}),(0,b.jsx)(f.Form.Item,{label:"สถานะกิจกรรม",name:"status",rules:[{required:!0,message:"กรุณาเลือกสถานะกิจกรรม"}],children:(0,b.jsx)(j.Select,{options:y})})]}),(0,b.jsx)(f.Form.Item,{label:"รายละเอียดเพิ่มเติม",name:"note",children:(0,b.jsx)(g.Input.TextArea,{rows:4})})]})}),(0,b.jsx)(h.Modal,{title:"รายละเอียดกิจกรรม",open:ab,onCancel:()=>{ac(!1),ag(null)},footer:null,width:780,children:af&&(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"ชื่อกิจกรรม"}),(0,b.jsx)("div",{className:"font-medium",children:af.name||af.title})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"ประเภทกิจกรรม"}),(0,b.jsx)(n.Tag,{color:"green",children:af.typeActivity?.name||"ยังไม่กำหนดประเภท"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"ภาควิชา"}),(0,b.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:E(af).map(a=>(0,b.jsx)(n.Tag,{color:"blue",children:a.name},a.id))})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"สาขาวิชา"}),(0,b.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:F(af).length>0?F(af).map(a=>(0,b.jsxs)(n.Tag,{color:"#0A894C",children:[a.major?.code?`${a.major.code} - `:"",a.major?.name||a.majorId]},a.majorId)):(0,b.jsx)("span",{className:"text-gray-500 text-sm",children:"ทุกสาขาในภาคที่เลือก"})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"วันเวลาเริ่มกิจกรรม"}),(0,b.jsx)("div",{children:C(af.startAt||af.startDate)||"-"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"วันเวลาสิ้นสุดกิจกรรม"}),(0,b.jsx)("div",{children:C(af.endAt||af.endDate)||"-"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"สถานที่"}),(0,b.jsx)("div",{children:af.location||af.address||"-"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500 text-sm",children:"รายละเอียดเพิ่มเติม"}),(0,b.jsx)("div",{children:af.note||af.description||"-"})]})]})})]})})}a.s(["default",()=>G])}];

//# sourceMappingURL=src_app_admin_event_page_49ce1032.js.map